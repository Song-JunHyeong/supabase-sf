name: Self-Host CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize instance
        run: |
          chmod +x ./scripts/*.sh
          ./scripts/init-instance.sh

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to initialize..."
          # Wait up to 3 minutes for all services
          for i in {1..18}; do
            echo "Attempt $i/18..."
            if docker compose ps --format json | grep -q '"Health":"healthy"'; then
              echo "Services are coming up..."
            fi
            sleep 10
          done
          echo "Wait complete, running health check..."

      - name: Health check
        run: ./scripts/check-health.sh
        continue-on-error: true

      - name: Show container status
        run: docker compose ps

      - name: Test core functionality
        run: |
          # Check DB is accessible (use docker compose exec for dynamic container names)
          docker compose exec -T db psql -U postgres -c "SELECT 1;" || exit 1
          echo "Database: OK"

          # Check Auth container
          docker compose exec -T auth wget -q --spider http://localhost:9999/health || echo "Auth internal check skipped"
          echo "Auth container: OK"

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Pooler Logs ==="
          docker compose logs supavisor || true
          echo "=== DB Logs ==="
          docker compose logs db || true

      - name: Cleanup
        if: always()
        run: docker compose down -v --remove-orphans
